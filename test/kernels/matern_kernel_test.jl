using Base.Test, GpABC

@testset "Matern Kernel Tests" begin
    mi1 = ExponentialIsoKernel()
    mi3 = MaternIsoKernel(3)
    mi5 = MaternIsoKernel(5)

    ma1 = ExponentialArdKernel()
    ma3 = MaternArdKernel(3)
    ma5 = MaternArdKernel(5)

    R57 = [
        0.791406184803418	0.290820793849798	0.273243301209641	0.976630407840307	0.919637321922759	0.373113582084474	0.167134671084180;
        0.163747991045820	0.825082233559844	0.400163430441247	0.227264572040767	0.344469555814038	0.919974093753832	0.0324169118108307;
        0.112485507089871	0.157099440301349	0.546775426038902	0.635662289166666	0.499824566533707	0.00459372066175273	0.831036804630904;
        0.543917659457735	0.370293144774760	0.654585435825673	0.576094024151607	0.551489732019366	0.206663162078086	0.235575431601878;
        0.624102506145883	0.516884229386637	0.617419922080552	0.412263916066039	0.887926049478318	0.387765046389664	0.316278932763393;
    ]
    R55 = [
        0.700022954354073	0.281477719210776	0.145081796750930	0.243184048330031	0.327940463706823;
        0.285793828911052	0.796026775518445	0.389757992881238	0.194300282837032	0.695373520578897;
        0.336882508051061	0.822016138500542	0.662586354959098	0.604853641989107	0.142760369527508;
        0.984312814187404	0.625239778601211	0.0888677975576687	0.775160910922643	0.373530648822678;
        0.345468047701506	0.404958950544223	0.601073551737272	0.129429876864622	0.929614762742824;
    ]
    x1 = [
        0.289686565422307	0.400690696388805;
        0.762105052714285	0.408534206640224;
        0.699620968987989	0.234411002245923;
        0.529625781127078	0.745714747228527;
        0.420503402790289	0.227756669850907;
    ]
    x2 = [
        0.906350184188387	0.112500416632975;
        0.0275456542277456	0.794502350406024;
        0.959810605719597	0.201003274042627;
        0.536850329272845	0.262026834423666;
        0.843484088705612	0.885006158559120;
        0.437078875227402	0.298506903135454;
        0.984655946951665	0.00552099757153587;
    ]

    @testset "Check hyperparameters" begin
        @test 2 == get_hyperparameters_size(mi1, zeros(0, 0))
        @test 2 == get_hyperparameters_size(mi3, zeros(0, 0))
        @test 5 == get_hyperparameters_size(ma5, zeros(0, 4))
        @test 4 == get_hyperparameters_size(ma3, zeros(0, 3))
    end

    log_theta = log.([4, 2, 3])
    @testset "Matern ARD ν = 1 (Exponential ARD)" begin
        M = [
            11.5841611485303	13.2909793837280	11.3700092357433	14.0222586904381	11.6123040446907	14.7523433872054	11.0339312696684
            14.1591849555517	10.8419960392437	14.1814529341518	14.1516238340854	13.5805061233645	13.5446082674416	13.4388537336879
            14.3180788074261	10.8935494907303	14.0415131311797	14.7417626826706	12.7318338836143	14.0074644436926	13.6117512667987
            12.0575422606651	12.4413109254846	12.0746218530243	13.6169992534182	13.5845752777948	13.6877679310735	11.4383386327386
            12.5114734394976	12.1827554326725	12.2165024727785	15.0790185190317	11.7997688428430	15.6050010869727	11.9525830328299
        ]
        @test M ≈ covariance(ma1, log_theta, x1, x2)

        M = [
            16	12.6336641564393	12.9391758368811	13.5501472509310	14.6641249897463;
            12.6336641564393	16	14.9793620729469	13.6112655419223	13.3493771316819;
            12.9391758368811	14.9793620729469	16	13.2253470207306	13.9156250513432;
            13.5501472509310	13.6112655419223	13.2253470207306	16	13.3500485055730;
            14.6641249897463	13.3493771316819	13.9156250513432	13.3500485055730	16;
        ]
        @test M ≈ covariance_training(ma1, log_theta, x1)
        @test M ≈ covariance_training(ma1, log_theta, x1) # test hitting the cache
        dM = [343.921478384293, 10.3213449835906, 6.38933255398455]
        @test dM ≈ covariance_grad(ma1, log_theta, x1, R55)
        @test dM ≈ covariance_grad(ma1, log_theta, x1, R55)
    end

    @testset "Matern ARD ν = 3" begin
        M = [
            14.2606234566307	15.3314244048386	14.0932626383531	15.6407043245208	14.2820869992591	15.8558852837985	13.8164059103774;
            15.6882654783931	13.6506275988849	15.6956880091364	15.6857252510439	15.4649217521938	15.4491509635950	15.4014022972021;
            15.7393100068678	13.6956968927578	15.6475915262437	15.8534468545973	15.0333663530316	15.6353683076306	15.4784676598925;
            14.6050405864475	14.8579266649518	14.6168010730980	15.4807263285850	15.4666954161076	15.5107194381009	14.1474345463901;
            14.9015687011262	14.6901700399937	14.7126814838511	15.9212064638772	14.4218893190551	15.9854291910391	14.5317433595824;
        ]
        @test M ≈ covariance(ma3, log_theta, x1, x2)

        M = [
            16	14.9756414903414	15.1500190215362	15.4515988541525	15.8349379559396;
            14.9756414903414	16	15.9033310682782	15.4782583694961	15.3595059433015;
            15.1500190215362	15.9033310682782	16	15.2991709179202	15.6013855729400;
            15.4515988541525	15.4782583694961	15.2991709179202	16	15.3598254022276;
            15.8349379559396	15.3595059433015	15.6013855729400	15.3598254022276	16;
        ]
        @test M ≈ covariance_training(ma3, log_theta, x1)
        @test M ≈ covariance_training(ma3, log_theta, x1) # test hitting the cache
        dM = [372.084465282425, 4.78654375158504, 2.63809480215839]
        @test dM ≈ covariance_grad(ma3, log_theta, x1, R55)
        @test dM ≈ covariance_grad(ma3, log_theta, x1, R55)
    end

    @testset "Matern ARD ν = 5" begin
        M = [
            14.7343138231780	15.5570668558234	14.5972409963104	15.7722064253454	14.7517474101827	15.9127738901835	14.3662583343162;
            15.8040342966367	14.2255566733735	15.8089663802905	15.8023441542700	15.6515275009666	15.6404870077301	15.6068623435658;
            15.8377502311411	14.2639800921978	15.7768388221507	15.9112366875537	15.3387491805615	15.7686120399016	15.6609839364099;
            15.0098474591547	15.2060276946967	15.0190909685638	15.6625583124446	15.6527671021026	15.6833984211323	14.6418265876983;
            15.2393134357353	15.0764988027662	15.0940223135409	15.9533299666004	14.8644632222004	15.9916747989222	14.9519841042042;
        ]
        @test M ≈ covariance(ma5, log_theta, x1, x2)

        M = [
            16	15.2954029325564	15.4253279991210	15.6422028359281	15.8995197460673;
            15.2954029325564	16	15.9423599184652	15.6608380182498	15.5771213867627;
            15.4253279991210	15.9423599184652	16	15.5339169075397	15.7456140607006;
            15.6422028359281	15.6608380182498	15.5339169075397	16	15.5773489802123;
            15.8995197460673	15.5771213867627	15.7456140607006	15.5773489802123	16;
        ]
        @test M ≈ covariance_training(ma5, log_theta, x1)
        @test M ≈ covariance_training(ma5, log_theta, x1) # test hitting the cache
        dM = [374.899359986320, 3.42341729639196, 1.84924721006274]
        @test dM ≈ covariance_grad(ma5, log_theta, x1, R55)
        @test dM ≈ covariance_grad(ma5, log_theta, x1, R55)
    end

    log_theta = log.([3, 2])
    @testset "Matern ISO ν = 1 (Exponential ISO)" begin
        M = [
            6.40374962810124	7.10418580254636	6.34459259548824	7.81092023069155	6.22999187130739	8.22805896019984	6.03449962280165;
            7.63369048671289	5.94369110438302	7.79833100550643	7.86852381596106	7.06772605737364	7.58105534779673	7.14944854706554;
            7.98229092078633	5.81123101055548	7.89367475245528	8.28690232217822	6.44992796519164	7.86244889530660	7.49655498249347;
            6.22654782625103	6.99364663956730	6.36094189979183	7.06641758711903	7.58016585194165	7.16267020929581	5.82866729459857;
            7.01155324353779	6.37510026018038	6.87051722595412	8.47041933396979	6.08865655531065	8.67887226766782	6.64623836344120;
        ]
        @test M ≈ covariance(mi1, log_theta, x1, x2)

        M = [
            9.00000000000000	7.10630756931683	7.21409934498584	7.29433612106788	8.07525942876702;
            7.10630756931683	9.00000000000000	8.20486339969566	7.33344827035029	7.41853111640394;
            7.21409934498584	8.20486339969566	9.00000000000000	6.87446096867600	7.82736665827119;
            7.29433612106788	7.33344827035029	6.87446096867600	9.00000000000000	6.90717354045213;
            8.07525942876702	7.41853111640394	7.82736665827119	6.90717354045213	9.00000000000000;
        ]
        @test M ≈ covariance_training(mi1, log_theta, x1)
        @test M ≈ covariance_training(mi1, log_theta, x1) # test hitting the cache
        dM = [1.897023548035826e+02, 10.937241608256016]
        @test dM ≈ covariance_grad(mi1, log_theta, x1, R55)
        @test dM ≈ covariance_grad(mi1, log_theta, x1, R55)
    end

    @testset "Matern ISO ν = 3" begin
        M = [
            7.93393113569130	8.42245612528808	7.88637218712751	8.76945360658600	7.79153343442712	8.90205231203270	7.62163123534655;
            8.69668280017932	7.53928310045817	8.76460460450300	8.79101280527447	8.40050220472439	8.67321166928089	8.44916746012979;
            8.83055114163477	7.41533561669713	8.80010200913708	8.91632373211294	7.97038942178510	8.78878784805798	8.63376437028541;
            7.78862840945221	8.35469878668682	7.89961169913462	8.39970708049495	8.67280774994901	8.45685621289903	7.43190859244578;
            8.36591711705520	7.91101807687226	8.27504244294758	8.95369379680283	7.66971390180964	8.98290915814688	8.11878436808226;
        ]
        @test M ≈ covariance(mi3, log_theta, x1, x2)

        M = [
            9.00000000000000	8.42372172166323	8.48627246543244	8.53059901714994	8.85984522808927;
            8.42372172166323	9.00000000000000	8.89612286961489	8.55151073279344	8.59541763287696;
            8.48627246543244	8.89612286961489	9.00000000000000	8.27766161438813	8.77571419045471;
            8.53059901714994	8.55151073279344	8.27766161438813	9.00000000000000	8.29921452470236;
            8.85984522808927	8.59541763287696	8.77571419045471	8.29921452470236	9.00000000000000;
        ]
        @test M ≈ covariance_training(mi3, log_theta, x1)
        @test M ≈ covariance_training(mi3, log_theta, x1) # test hitting the cache

        dM = [2.075347189222474e+02, 5.640324374231643]
        @test dM ≈ covariance_grad(mi3, log_theta, x1, R55)
        @test dM ≈ covariance_grad(mi3, log_theta, x1, R55)
    end

    @testset "Matern ISO ν = 5" begin
        M = [
            8.21628350836750	8.60265235780503	8.17694984988844	8.85260451476692	8.09770244385133	8.94023400295971	7.95315483120493;
            8.80235090146831	7.88196229213989	8.84929839376336	8.86722556621832	8.58605965183515	8.78586698304239	8.62272975106313;
            8.89368929059150	7.77347792304969	8.87335031095893	8.94928811634894	8.24624704244772	8.86572266891085	8.75788234151801;
            8.09525833173716	8.55118379701449	8.18792735222480	8.58545717782324	8.78558219613035	8.62848598818880	7.78807358815230;
            8.55975743019400	8.19736780846164	8.48973373024520	8.97253479008701	7.99438732934831	8.99011500600917	8.36644127154376;
        ]
        @test M ≈ covariance(mi5, log_theta, x1, x2)

        M = [
            9.00000000000000	8.60360640239698	8.65041199909894	8.68315433586136	8.91297887699073;
            8.60360640239698	9.00000000000000	8.93644682441130	8.69847279148807	8.73035734382252;
            8.65041199909894	8.93644682441130	9.00000000000000	8.49176986934424	8.85686361374794;
            8.68315433586136	8.69847279148807	8.49176986934424	9.00000000000000	8.50848531932549;
            8.91297887699073	8.73035734382252	8.85686361374794	8.50848531932549	9.00000000000000;
        ]
        @test M ≈ covariance_training(mi5, log_theta, x1)
        @test M ≈ covariance_training(mi5, log_theta, x1) # test hitting the cache

        dM = [2.096069712802733e+02; 4.150924998668864]
        @test dM ≈ covariance_grad(mi5, log_theta, x1, R55)
        @test dM ≈ covariance_grad(mi5, log_theta, x1, R55)

    end

end
