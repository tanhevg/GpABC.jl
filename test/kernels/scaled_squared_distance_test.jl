using GpABC, Base.Test
import GpABC.scaled_squared_distance, GpABC.scaled_squared_distance_grad

@testset "Scaled Squared Distance Tests" begin

    D2 = [
        1.67814152778737 1.20785927753982 0.624461685654236 1.46408315059547 8.48310688500901 1.45871370121154 6.42543323212624;
        1.14246534460365 1.85035457131647 1.19053740612926 0.611497365423743 6.99118646721199 2.43597535692027 5.07544002153986;
        7.23733046161335 3.16542101637104 2.72647762438244 8.92586928526950 17.1642767758545 1.17728913861911 14.7362524561371;
        19.0995257794008 4.56588070446465 5.99211031953106 11.1739924041597 34.8720573587766 15.7837441497418 30.3384444420246;
        0.466988806886986 3.56126964624601 2.47101254290117 2.18123029882355 4.99339934819349 1.06659412805776 3.56150053043329
    ]
    x1 = [
        0.459530675532078 0.485182659460782;
        0.332063667630806 0.464957557369470;
        0.994061870963342 0.541666708673195;
        0.197865280880530 0.792372670393611;
        0.521775759068213 0.407471305414788
    ]
    x2 = [
        0.370230106343622 0.358754987995492;
        0.457397317261154 0.595083240231072;
        0.476711208222765 0.564018563630068;
        0.0852766000131502 0.459998930552974;
        0.243816421015103 0.202025803831418;
        0.822588000829605 0.447684994641545;
        0.236529943177723 0.241704940442790
    ]
    log_theta = [-log(10)/2, -log(100)/2]
    @test D2 ≈ scaled_squared_distance(log_theta, x1, x2)
    D2D = [
        0 0.203383856493429 3.17628077043479 10.1212580692727 0.642649959010387;
        0.203383856493429 0 4.97084560152883 10.9001576937249 0.690373692755269;
        3.17628077043479 4.97084560152883 0 12.6246380248108 4.03138234045883;
        10.1212580692727 10.9001576937249 12.6246380248108 0 15.8640860550538;
        0.642649959010387 0.690373692755269 4.03138234045883 15.8640860550539 0
    ]
    @test D2D ≈ scaled_squared_distance(log_theta, x1, x1)

    x1 = [
        0.289686565422307	0.400690696388805;
        0.762105052714285	0.408534206640224;
        0.699620968987989	0.234411002245923;
        0.529625781127078	0.745714747228527;
        0.420503402790289	0.227756669850907;
    ]
    x2 = [
        0.906350184188387	0.112500416632975;
        0.0275456542277456	0.794502350406024;
        0.959810605719597	0.201003274042627;
        0.536850329272845	0.262026834423666;
        0.843484088705612	0.885006158559120;
        0.437078875227402	0.298506903135454;
        0.984655946951665	0.00552099757153587;
    ]
    log_theta = log.([2, 3])

    R57 = [
        0.791406184803418	0.290820793849798	0.273243301209641	0.976630407840307	0.919637321922759	0.373113582084474	0.167134671084180;
        0.163747991045820	0.825082233559844	0.400163430441247	0.227264572040767	0.344469555814038	0.919974093753832	0.0324169118108307;
        0.112485507089871	0.157099440301349	0.546775426038902	0.635662289166666	0.499824566533707	0.00459372066175273	0.831036804630904;
        0.543917659457735	0.370293144774760	0.654585435825673	0.576094024151607	0.551489732019366	0.206663162078086	0.235575431601878;
        0.624102506145883	0.516884229386637	0.617419922080552	0.412263916066039	0.887926049478318	0.387765046389664	0.316278932763393;
    ]
    R55 = [
        0.700022954354073	0.281477719210776	0.145081796750930	0.243184048330031	0.327940463706823;
        0.285793828911052	0.796026775518445	0.389757992881238	0.194300282837032	0.695373520578897;
        0.336882508051061	0.822016138500542	0.662586354959098	0.604853641989107	0.142760369527508;
        0.984312814187404	0.625239778601211	0.0888677975576687	0.775160910922643	0.373530648822678;
        0.345468047701506	0.404958950544223	0.601073551737272	0.129429876864622	0.929614762742824;
    ]

    @test scaled_squared_distance([0.0], ones(5,3), ones(7, 3)) == zeros(5, 7)
    @test scaled_squared_distance(zeros(4), ones(5,4), ones(7, 4) * 0.5) == ones(5, 7)

    @test [-1.36366400189887, -0.500622886827688] ≈ scaled_squared_distance_grad(log_theta, x1, x2, R57)
    @test [-0.275598889477765, -0.147072058193387] ≈ scaled_squared_distance_grad(log_theta, x1, x1, R55)

end
